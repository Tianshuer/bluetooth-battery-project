<template>
  <page-meta :page-style="'overflow:'+(show?'hidden':'visible')">
    <view class="container" :style="{ 
      minHeight: screenHeight + 'px',
      marginTop: statusBarHeight + 'px',
      paddingBottom: !isConnected ? '120rpx' : '20rpx',
    }">
      <!-- ÁîµÊ±†Áä∂ÊÄÅÂç°Áâá -->
      <BatteryCard :batteryPercentage="batteryLevel" @language-popup-action="handleLanguagePopupAction" />
      
      <!-- ÊòæÁ§∫‰∏éÊéßÂà∂ÂäüËÉΩÁªÑ‰ª∂ -->
      <CommonPanel
        :showVerifyCode="false"
        :functionButtons="controlButtons"
        @functionClick="handleControlClick"
      />
      
      <!-- ÂèåÂàóÊï∞ÊçÆÊòæÁ§∫ÁªÑ‰ª∂ - ÁîµÊ±†‰∏≤ÁîµÂéã -->
      <DoubleColumnData
        :dataItems="safeBatteryVoltageData"
        :valueFormat="voltageFormat"
        :emptyConfig="voltageEmptyConfig"
      />
    </view>
  </page-meta>
</template>

<script>
    import BatteryCard from '../../../components/BatteryCard.vue'
    import CommonPanel from '../../../components/CommonPanel.vue'
    import DoubleColumnData from '../../../components/DoubleColumnData.vue'
    import { mapGetters } from 'vuex'
    
    export default {
        components: {
            BatteryCard,
            CommonPanel,
            DoubleColumnData
        },
        data() {
            return {
                show: false,
                screenHeight: 0,
                currentBatteryVoltageData: [],
                // ËÆæÂ§áÁä∂ÊÄÅ
                deviceStatus: {
                  charging: false,
                  discharging: false,
                  balancing: false
                },
                // ÁîµÂéãÊ†ºÂºèÂåñÈÖçÁΩÆ
                voltageFormat: {
                  decimals: 4,
                  padding: true
                },
            };
        },
        computed: {
            ...mapGetters([
                't',
                'isConnected',
                'isPasswordVerified',
                'statusBarHeight',
                'batteryData'
            ]),
            safeBatteryVoltageData() {
              const data = this.currentBatteryVoltageData.length > 0 ? this.currentBatteryVoltageData : this.getDefaultBatteryVoltageData();
              return Array.isArray(data) ? data : [];
            },
            // ÊéßÂà∂ÊåâÈíÆÈÖçÁΩÆ - ÂìçÂ∫îËØ≠Ë®ÄÂèòÂåñ
            controlButtons() {
              return [
                {
                  text: this.t('start_charging'),
                  action: 'chargeOn',
                  color: '#34C759'
                },
                {
                  text: this.t('stop_charging'),
                  action: 'chargeOff',
                  color: '#FF3B30'
                },
                {
                  text: this.t('start_discharging'),
                  action: 'dischargeOn',
                  color: '#FF9500'
                },
                {
                  text: this.t('stop_discharging'),
                  action: 'dischargeOff',
                  color: '#FF3B30'
                },
                {
                  text: this.t('one_key_balance'),
                  action: 'autoBalance',
                  color: '#007AFF'
                },
                {
                  text: this.t('restart_device'),
                  action: 'restartDevice',
                  color: '#AF52DE'
                }
              ];
            },
            // ÁîµÂéãÁ©∫ÊÄÅÈÖçÁΩÆ - ÂìçÂ∫îËØ≠Ë®ÄÂèòÂåñ
            voltageEmptyConfig() {
              return {
                title: this.t('device_not_connected'),
                description: this.t('check_device_connection'),
                showButton: true,
                buttonText: this.t('connect_device'),
                icon: 'üîã'
              }
            }
        },
        watch: {
          batteryLevel: {
            handler(newData) {
              this.batteryLevel = newData;
            },
            immediate: true,
            deep: true
          },
          // ÁõëÂê¨store‰∏≠ÁöÑÁîµÊ±†Êï∞ÊçÆÂèòÂåñÔºåÊõ¥Êñ∞ËÆæÂ§áÁä∂ÊÄÅ
          batteryData: {
            handler(newData) {
              if (newData) {
                this.deviceStatus = {
                  charging: newData.chargingStatus || false,
                  discharging: newData.dischargingStatus || false,
                  balancing: newData.balancingStatus || false
                };
                if (newData.voltages) {
                  this.currentBatteryVoltageData = newData.voltages.map((voltage, index) => ({
                    label: `${index + 1}`,
                    value: voltage || 0,
                    unit: 'V'
                  }));
                }
              }
            },
            immediate: true,
            deep: true
          },
        },
        onLoad() {
            this.getScreenHeight();
        },
        methods: {
            // Ëé∑ÂèñÂ±èÂπïÈ´òÂ∫¶
            getScreenHeight() {
              const windowInfo = uni.getWindowInfo()
		          this.screenHeight = windowInfo.windowHeight;
            },
            
            getDefaultBatteryVoltageData() {
              let fakeData = []
              for (let i = 0; i < 20; i++) {
                fakeData.push({
                  label: i + 1,
                  value: '0.0000',
                  unit: 'V',
                })
              }
              return fakeData;
            },
            // ËøûÊé•ËÆæÂ§á
            connectDevice() {
              uni.showLoading({
                title: this.t('connecting'),
                mask: true,
              });
              
              setTimeout(() => {
                this.initializeData();
                uni.hideLoading();
                uni.showToast({
                  title: this.t('connection_success'),
                  icon: 'success'
                });
              }, 3000);
            },
            
            // Êñ≠ÂºÄËÆæÂ§áËøûÊé•
            disconnectDevice() {
              console.log('Êñ≠ÂºÄËøûÊé•');
            },
            
            // ÂàùÂßãÂåñÊï∞ÊçÆ
            initializeData() {
              if (!this.isConnected) return;
              
              // Á°Æ‰øù deviceStatus Â∑≤ÂàùÂßãÂåñ
              if (!this.deviceStatus) {
                this.deviceStatus = {
                  charging: false,
                  discharging: false,
                  balancing: false
                };
              }
            },

            checkBeforeControl(actionCallback) {
              // 1. Ê£ÄÊü•ËìùÁâôËøûÊé•
              if (!this.isConnected) {
                uni.showToast({
                  title: this.t('ble_not_ready'),
                  icon: 'none'
                });
                return;
              }
                  
              // 2. Ê£ÄÊü•ÂØÜÁ†ÅÈ™åËØÅ
              if (!this.isPasswordVerified) {
                uni.showToast({
                  title: this.t('please_verify_password'),
                  icon: 'none'
                });
                return;
              }
              
              // 3. ÊâßË°åÊìç‰Ωú
              actionCallback();
            },
                
            // ÊéßÂà∂ÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
            handleControlClick({ button, index }) {
              this.checkBeforeControl(() => {
                // ÂØÜÁ†ÅÈ™åËØÅÈÄöËøáÂêéÂÜçÊâßË°åÂéüÊúâÈÄªËæë
                this.doControlAction(button, index);
              });
            },
            
            // ÂéüÊúâÊéßÂà∂ÈÄªËæë
            doControlAction(button, index) {
              switch(button.action) {
                case 'chargeOn':
                  this.handleChargeOn();
                  break;
                case 'chargeOff':
                  this.handleChargeOff();
                  break;
                case 'dischargeOn':
                  this.handleDischargeOn();
                  break;
                case 'dischargeOff':
                  this.handleDischargeOff();
                  break;
                case 'autoBalance':
                  this.handleAutoBalance();
                  break;
                case 'restartDevice':
                  this.handleRestartDevice();
                  break;
              }
            },
            
            // ÂÖÖÁîµÂºÄÂêØ
            handleChargeOn() {
              if (this.deviceStatus.charging) {
                uni.showToast({
                  title: 'ÂÖÖÁîµÂ∑≤ÁªèÂºÄÂêØ',
                  icon: 'none'
                });
                return;
              }
              
              if (this.deviceStatus.discharging) {
                uni.showToast({
                  title: 'ËØ∑ÂÖàÂÖ≥Èó≠ÊîæÁîµ',
                  icon: 'none'
                });
                return;
              }
              
              uni.showLoading({
                title: 'Ê≠£Âú®ÂºÄÂêØÂÖÖÁîµ...',
                mask: true
              });
              
              setTimeout(() => {
                this.deviceStatus.charging = true;
                uni.hideLoading();
                uni.showToast({
                  title: 'ÂÖÖÁîµÂ∑≤ÂºÄÂêØ',
                  icon: 'success'
                });
                
                // Ê®°ÊãüÁîµÊ±†ÁîµÈáèÂ¢ûÂä†
                this.startChargingSimulation();
              }, 1500);
            },
            
            // ÂÖÖÁîµÂÖ≥Èó≠
            handleChargeOff() {
              if (!this.deviceStatus.charging) {
                uni.showToast({
                  title: 'ÂÖÖÁîµÊú™ÂºÄÂêØ',
                  icon: 'none'
                });
                return;
              }
              
              uni.showLoading({
                title: 'Ê≠£Âú®ÂÖ≥Èó≠ÂÖÖÁîµ...',
                mask: true
              });
              
              setTimeout(() => {
                this.deviceStatus.charging = false;
                this.stopChargingSimulation();
                uni.hideLoading();
                uni.showToast({
                  title: 'ÂÖÖÁîµÂ∑≤ÂÖ≥Èó≠',
                  icon: 'success'
                });
              }, 1000);
            },
            
            // ÊîæÁîµÂºÄÂêØ
            handleDischargeOn() {
              if (this.deviceStatus.discharging) {
                uni.showToast({
                  title: 'ÊîæÁîµÂ∑≤ÁªèÂºÄÂêØ',
                  icon: 'none'
                });
                return;
              }
              
              if (this.deviceStatus.charging) {
                uni.showToast({
                  title: 'ËØ∑ÂÖàÂÖ≥Èó≠ÂÖÖÁîµ',
                  icon: 'none'
                });
                return;
              }
              
              uni.showLoading({
                title: 'Ê≠£Âú®ÂºÄÂêØÊîæÁîµ...',
                mask: true
              });
              
              setTimeout(() => {
                this.deviceStatus.discharging = true;
                uni.hideLoading();
                uni.showToast({
                  title: 'ÊîæÁîµÂ∑≤ÂºÄÂêØ',
                  icon: 'success'
                });
                
                // Ê®°ÊãüÁîµÊ±†ÁîµÈáèÂáèÂ∞ë
                this.startDischargingSimulation();
              }, 1500);
            },
            
            // ÊîæÁîµÂÖ≥Èó≠
            handleDischargeOff() {
              if (!this.deviceStatus.discharging) {
                uni.showToast({
                  title: 'ÊîæÁîµÊú™ÂºÄÂêØ',
                  icon: 'none'
                });
                return;
              }
              
              uni.showLoading({
                title: 'Ê≠£Âú®ÂÖ≥Èó≠ÊîæÁîµ...',
                mask: true
              });
              
              setTimeout(() => {
                this.deviceStatus.discharging = false;
                this.stopDischargingSimulation();
                uni.hideLoading();
                uni.showToast({
                  title: 'ÊîæÁîµÂ∑≤ÂÖ≥Èó≠',
                  icon: 'success'
                });
              }, 1000);
            },
            
            // ‰∏ÄÈîÆÂùáË°°
            handleAutoBalance() {
              if (this.deviceStatus.balancing) {
                uni.showToast({
                  title: 'ÂùáË°°Ê≠£Âú®ËøõË°å‰∏≠',
                  icon: 'none'
                });
                return;
              }
              
              uni.showModal({
                title: 'Á°ÆËÆ§Êìç‰Ωú',
                content: 'Á°ÆÂÆöË¶ÅÂºÄÂßã‰∏ÄÈîÆÂùáË°°ÂêóÔºüÊ≠§ËøáÁ®ãÂèØËÉΩÈúÄË¶ÅËæÉÈïøÊó∂Èó¥„ÄÇ',
                success: (res) => {
                  if (res.confirm) {
                    this.startBalancing();
                  }
                }
              });
            },
            
            // ÂºÄÂßãÂùáË°°
            startBalancing() {
              uni.showLoading({
                title: 'Ê≠£Âú®ÂêØÂä®ÂùáË°°...',
                mask: true
              });
              
              setTimeout(() => {
                this.deviceStatus.balancing = true;
                uni.hideLoading();
                uni.showToast({
                  title: 'ÂùáË°°Â∑≤ÂêØÂä®',
                  icon: 'success'
                });
                
                // Ê®°ÊãüÂùáË°°ËøáÁ®ã
                setTimeout(() => {
                  this.deviceStatus.balancing = false;
                  uni.showToast({
                    title: 'ÂùáË°°ÂÆåÊàê',
                    icon: 'success'
                  });
                }, 10000); // 10ÁßíÂêéÂÆåÊàêÂùáË°°
              }, 2000);
            },
            
            // ÈáçÂêØËÆæÂ§á
            handleRestartDevice() {
              uni.showModal({
                title: 'Á°ÆËÆ§ÈáçÂêØ',
                content: 'Á°ÆÂÆöË¶ÅÈáçÂêØËÆæÂ§áÂêóÔºüÈáçÂêØËøáÁ®ã‰∏≠‰ºöÊöÇÊó∂Êñ≠ÂºÄËøûÊé•„ÄÇ',
                confirmColor: '#FF3B30',
                success: (res) => {
                  if (res.confirm) {
                    this.restartDevice();
                  }
                }
              });
            },
            
            // ÊâßË°åÈáçÂêØ
            restartDevice() {
              uni.showLoading({
                title: 'Ê≠£Âú®ÈáçÂêØËÆæÂ§á...',
                mask: true
              });
              
              // Êñ≠ÂºÄËøûÊé•Âπ∂ÈáçÁΩÆÁä∂ÊÄÅ
              this.disconnectDevice();
              this.deviceStatus = {
                charging: false,
                discharging: false,
                balancing: false
              };
              
              setTimeout(() => {
                uni.hideLoading();
                uni.showToast({
                  title: 'ËÆæÂ§áÈáçÂêØÂÆåÊàê',
                  icon: 'success'
                });
                
                // ÈáçÊñ∞ËøûÊé•ËÆæÂ§á
                setTimeout(() => {
                  this.connectDevice();
                }, 1000);
              }, 3000);
            },
            
            // ÂÖÖÁîµÊ®°Êãü
            startChargingSimulation() {
              this.chargingTimer = setInterval(() => {
                if (this.deviceStatus.charging) {
                  // ËøôÈáåÂèØ‰ª•Ê†πÊçÆÂÆûÈôÖÈúÄÊ±ÇËøõË°åÂÖÖÁîµÊ®°Êãü
                  console.log('ÂÖÖÁîµÊ®°Êãü‰∏≠...');
                }
              }, 2000);
            },
            
            // ÂÅúÊ≠¢ÂÖÖÁîµÊ®°Êãü
            stopChargingSimulation() {
              if (this.chargingTimer) {
                clearInterval(this.chargingTimer);
                this.chargingTimer = null;
              }
            },
            
            // ÊîæÁîµÊ®°Êãü
            startDischargingSimulation() {
              console.log('ÊîæÁîµÊ®°Êãü');
            },
            
            // ÂÅúÊ≠¢ÊîæÁîµÊ®°Êãü
            stopDischargingSimulation() {
              if (this.dischargingTimer) {
                clearInterval(this.dischargingTimer);
                this.dischargingTimer = null;
              }
            },

            // Â§ÑÁêÜËØ≠Ë®ÄÂºπÁ™óÁä∂ÊÄÅÂèòÂåñ
            handleLanguagePopupAction(isOpen) {
              this.show = isOpen
      }
    },
  }
</script>

<style scoped>
    .container {
        display: flex;
        flex-direction: column;
        gap: 26rpx;
        background-color: #f8f8f8;
        padding: 20rpx;
        box-sizing: border-box;
    }
</style> 